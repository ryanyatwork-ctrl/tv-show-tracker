<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Track your TV shows and never lose your place again">
    <meta name="theme-color" content="#6B46C1">
    <title>TV Show Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .8; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Lucide React icons wrapper
        const Icon = ({ name, ...props }) => {
            useEffect(() => {
                lucide.createIcons();
            });
            return React.createElement('i', {
                'data-lucide': name,
                ...props
            });
        };

        function TVShowTracker() {
            // Load from localStorage or start with empty array
            const [myShows, setMyShows] = useState(() => {
                try {
                    const saved = localStorage.getItem('tvShowTrackerData');
                    return saved ? JSON.parse(saved) : [];
                } catch (error) {
                    console.error('Error loading data:', error);
                    return [];
                }
            });
            
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [isSearching, setIsSearching] = useState(false);
            const [expandedShow, setExpandedShow] = useState(null);
            const [expandedSeason, setExpandedSeason] = useState(null);
            const [filterStatus, setFilterStatus] = useState('all');

            // Save to localStorage whenever myShows changes
            useEffect(() => {
                try {
                    localStorage.setItem('tvShowTrackerData', JSON.stringify(myShows));
                } catch (error) {
                    console.error('Error saving data:', error);
                }
            }, [myShows]);

            // Search for TV shows
            const searchShows = async (query) => {
                if (!query.trim()) {
                    setSearchResults([]);
                    return;
                }

                setIsSearching(true);
                try {
                    const response = await fetch(`https://api.tvmaze.com/search/shows?q=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    setSearchResults(data);
                } catch (error) {
                    console.error('Error searching shows:', error);
                }
                setIsSearching(false);
            };

            // Fetch show details
            const fetchShowDetails = async (showId) => {
                try {
                    const response = await fetch(`https://api.tvmaze.com/shows/${showId}?embed=episodes`);
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Error fetching show details:', error);
                    return null;
                }
            };

            // Add show
            const addShow = async (show) => {
                const details = await fetchShowDetails(show.id);
                if (!details) return;

                const episodesBySeason = {};
                if (details._embedded && details._embedded.episodes) {
                    details._embedded.episodes.forEach(episode => {
                        const season = episode.season;
                        if (!episodesBySeason[season]) {
                            episodesBySeason[season] = [];
                        }
                        episodesBySeason[season].push({
                            id: episode.id,
                            number: episode.number,
                            name: episode.name,
                            airdate: episode.airdate,
                            watched: false
                        });
                    });
                }

                const newShow = {
                    id: show.id,
                    name: show.name,
                    premiered: details.premiered,
                    image: show.image?.medium || show.image?.original,
                    genres: details.genres || [],
                    source: '',
                    seasons: episodesBySeason,
                    addedDate: new Date().toISOString()
                };

                setMyShows(prev => [...prev, newShow]);
                setSearchQuery('');
                setSearchResults([]);
            };

            // Remove show
            const removeShow = (showId) => {
                if (confirm('Are you sure you want to remove this show?')) {
                    setMyShows(prev => prev.filter(show => show.id !== showId));
                }
            };

            // Toggle episode watched
            const toggleEpisodeWatched = (showId, season, episodeId) => {
                setMyShows(prev => prev.map(show => {
                    if (show.id === showId) {
                        return {
                            ...show,
                            seasons: {
                                ...show.seasons,
                                [season]: show.seasons[season].map(ep => 
                                    ep.id === episodeId ? { ...ep, watched: !ep.watched } : ep
                                )
                            }
                        };
                    }
                    return show;
                }));
            };

            // Update source
            const updateSource = (showId, source) => {
                setMyShows(prev => prev.map(show => 
                    show.id === showId ? { ...show, source } : show
                ));
            };

            // Calculate progress
            const getWatchProgress = (show) => {
                let total = 0;
                let watched = 0;
                Object.values(show.seasons).forEach(episodes => {
                    total += episodes.length;
                    watched += episodes.filter(ep => ep.watched).length;
                });
                return { watched, total, percentage: total > 0 ? Math.round((watched / total) * 100) : 0 };
            };

            const getSeasonProgress = (episodes) => {
                const watched = episodes.filter(ep => ep.watched).length;
                const total = episodes.length;
                return { watched, total };
            };

            // Export JSON
            const exportJSON = () => {
                const dataStr = JSON.stringify(myShows, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `tv-shows-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            // Export Excel
            const exportExcel = () => {
                const wb = XLSX.utils.book_new();
                
                // Summary Sheet
                const summaryData = [
                    ['TV Show Tracking Summary'],
                    [],
                    ['Show Name', 'Premiered', 'Genres', 'Source', 'Watched', 'Total', 'Progress %', 'Status']
                ];
                
                myShows.forEach(show => {
                    const totalEps = Object.values(show.seasons).reduce((sum, eps) => sum + eps.length, 0);
                    const watchedEps = Object.values(show.seasons).reduce(
                        (sum, eps) => sum + eps.filter(ep => ep.watched).length, 0
                    );
                    const progress = totalEps > 0 ? (watchedEps / totalEps) : 0;
                    
                    summaryData.push([
                        show.name,
                        show.premiered ? show.premiered.split('-')[0] : '',
                        show.genres.join(', '),
                        show.source || '',
                        watchedEps,
                        totalEps,
                        progress,
                        progress === 1 ? 'âœ“ COMPLETED' : 'In Progress'
                    ]);
                });
                
                const summaryWS = XLSX.utils.aoa_to_sheet(summaryData);
                summaryWS['!cols'] = [
                    { wch: 30 }, { wch: 12 }, { wch: 20 }, { wch: 20 }, 
                    { wch: 10 }, { wch: 10 }, { wch: 12 }, { wch: 15 }
                ];
                
                for (let i = 3; i < summaryData.length; i++) {
                    const cell = XLSX.utils.encode_cell({ r: i, c: 6 });
                    if (summaryWS[cell]) {
                        summaryWS[cell].z = '0%';
                    }
                }
                
                XLSX.utils.book_append_sheet(wb, summaryWS, 'Summary');
                
                // Individual sheets for each show
                myShows.forEach(show => {
                    const showData = [
                        [show.name],
                        [`Premiered: ${show.premiered || 'N/A'} | Genres: ${show.genres.join(', ')} | Source: ${show.source || 'Not specified'}`],
                        [],
                        ['Season', 'Episode #', 'Episode Name', 'Air Date', 'Watched', 'Status']
                    ];
                    
                    Object.keys(show.seasons).sort((a, b) => Number(a) - Number(b)).forEach(seasonNum => {
                        show.seasons[seasonNum].forEach(episode => {
                            showData.push([
                                seasonNum,
                                episode.number,
                                episode.name,
                                episode.airdate || '',
                                episode.watched ? 'âœ“' : 'â—‹',
                                episode.watched ? 'Watched' : 'Not Watched'
                            ]);
                        });
                    });
                    
                    const totalEps = Object.values(show.seasons).reduce((sum, eps) => sum + eps.length, 0);
                    const watchedEps = Object.values(show.seasons).reduce(
                        (sum, eps) => sum + eps.filter(ep => ep.watched).length, 0
                    );
                    
                    showData.push([]);
                    showData.push(['Summary Statistics']);
                    showData.push(['Total Episodes:', totalEps]);
                    showData.push(['Watched:', watchedEps]);
                    showData.push(['Progress:', totalEps > 0 ? (watchedEps / totalEps) : 0]);
                    
                    const showWS = XLSX.utils.aoa_to_sheet(showData);
                    showWS['!cols'] = [
                        { wch: 10 }, { wch: 12 }, { wch: 40 }, 
                        { wch: 12 }, { wch: 10 }, { wch: 15 }
                    ];
                    
                    const progressRow = showData.length - 1;
                    const progressCell = XLSX.utils.encode_cell({ r: progressRow, c: 1 });
                    if (showWS[progressCell]) {
                        showWS[progressCell].z = '0%';
                    }
                    
                    let sheetName = show.name.substring(0, 31);
                    sheetName = sheetName.replace(/[:\\/?*\[\]]/g, '-');
                    
                    XLSX.utils.book_append_sheet(wb, showWS, sheetName);
                });
                
                XLSX.writeFile(wb, `tv-shows-${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            // Import data
            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        setMyShows(data);
                        alert('Data imported successfully!');
                    } catch (error) {
                        alert('Error importing data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            };

            // Debounce search
            useEffect(() => {
                const timer = setTimeout(() => {
                    searchShows(searchQuery);
                }, 500);
                return () => clearTimeout(timer);
            }, [searchQuery]);

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white p-4">
                    <div className="max-w-6xl mx-auto">
                        {/* Header */}
                        <div className="mb-8 text-center">
                            <div className="flex items-center justify-center gap-3 mb-2">
                                <Icon name="tv" className="w-10 h-10 text-purple-400" />
                                <h1 className="text-4xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                                    TV Show Tracker
                                </h1>
                            </div>
                            <p className="text-slate-300">Never lose track of what you're watching</p>
                        </div>

                        {/* Export/Import Buttons */}
                        <div className="mb-6 flex flex-wrap gap-3 justify-center">
                            <button
                                onClick={exportJSON}
                                disabled={myShows.length === 0}
                                className="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg transition-colors"
                            >
                                <Icon name="download" className="w-4 h-4" />
                                Export JSON
                            </button>
                            <button
                                onClick={exportExcel}
                                disabled={myShows.length === 0}
                                className="flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg transition-colors"
                            >
                                <Icon name="download" className="w-4 h-4" />
                                Export Excel
                            </button>
                            <label className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors cursor-pointer">
                                <Icon name="upload" className="w-4 h-4" />
                                Import Data
                                <input
                                    type="file"
                                    accept=".json"
                                    onChange={importData}
                                    className="hidden"
                                />
                            </label>
                        </div>

                        {/* Search Section */}
                        <div className="mb-8 bg-slate-800 rounded-lg p-6 shadow-xl">
                            <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
                                <Icon name="plus" className="w-5 h-5 text-purple-400" />
                                Add New Series
                            </h2>
                            <div className="relative">
                                <Icon name="search" className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-5 h-5" />
                                <input
                                    type="text"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    placeholder="Search for a TV show..."
                                    className="w-full pl-12 pr-4 py-3 bg-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-white"
                                />
                            </div>

                            {isSearching && (
                                <div className="mt-4 text-center text-slate-400">Searching...</div>
                            )}
                            {searchResults.length > 0 && (
                                <div className="mt-4 space-y-2 max-h-96 overflow-y-auto">
                                    {searchResults.map(result => (
                                        <div
                                            key={result.show.id}
                                            className="flex items-center gap-4 p-3 bg-slate-700 rounded-lg hover:bg-slate-600 transition-colors"
                                        >
                                            {result.show.image?.medium && (
                                                <img
                                                    src={result.show.image.medium}
                                                    alt={result.show.name}
                                                    className="w-16 h-24 object-cover rounded"
                                                />
                                            )}
                                            <div className="flex-1">
                                                <h3 className="font-semibold">{result.show.name}</h3>
                                                <p className="text-sm text-slate-400">
                                                    {result.show.premiered ? `Premiered: ${result.show.premiered.split('-')[0]}` : 'N/A'}
                                                </p>
                                            </div>
                                            <button
                                                onClick={() => addShow(result.show)}
                                                className="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors"
                                            >
                                                Add
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* My Shows Section */}
                        <div className="space-y-4">
                            {myShows.length > 0 && (
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                    <div className="bg-slate-800 rounded-lg p-4 text-center">
                                        <div className="text-3xl font-bold text-purple-400">{myShows.length}</div>
                                        <div className="text-sm text-slate-400">Total Shows</div>
                                    </div>
                                    <div className="bg-slate-800 rounded-lg p-4 text-center">
                                        <div className="text-3xl font-bold text-yellow-400">
                                            {myShows.filter(show => {
                                                const progress = getWatchProgress(show);
                                                return progress.percentage < 100 && progress.percentage > 0;
                                            }).length}
                                        </div>
                                        <div className="text-sm text-slate-400">In Progress</div>
                                    </div>
                                    <div className="bg-slate-800 rounded-lg p-4 text-center">
                                        <div className="text-3xl font-bold text-green-400">
                                            {myShows.filter(show => {
                                                const progress = getWatchProgress(show);
                                                return progress.percentage === 100;
                                            }).length}
                                        </div>
                                        <div className="text-sm text-slate-400">Completed</div>
                                    </div>
                                </div>
                            )}
                            
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-2xl font-semibold">
                                    My Shows ({myShows.filter(show => {
                                        const progress = getWatchProgress(show);
                                        if (filterStatus === 'completed') return progress.percentage === 100;
                                        if (filterStatus === 'in-progress') return progress.percentage < 100;
                                        return true;
                                    }).length})
                                </h2>
                                
                                {myShows.length > 0 && (
                                    <select
                                        value={filterStatus}
                                        onChange={(e) => setFilterStatus(e.target.value)}
                                        className="px-4 py-2 bg-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-white"
                                    >
                                        <option value="all">All Shows</option>
                                        <option value="in-progress">In Progress</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                )}
                            </div>
                            
                            {myShows.length === 0 ? (
                                <div className="text-center py-12 bg-slate-800 rounded-lg">
                                    <Icon name="tv" className="w-16 h-16 mx-auto mb-4 text-slate-600" />
                                    <p className="text-slate-400">No shows added yet. Search and add your first show above!</p>
                                </div>
                            ) : (() => {
                                const filteredShows = myShows.filter(show => {
                                    const progress = getWatchProgress(show);
                                    if (filterStatus === 'completed') return progress.percentage === 100;
                                    if (filterStatus === 'in-progress') return progress.percentage < 100;
                                    return true;
                                });

                                if (filteredShows.length === 0) {
                                    return (
                                        <div className="text-center py-12 bg-slate-800 rounded-lg">
                                            <Icon name="tv" className="w-16 h-16 mx-auto mb-4 text-slate-600" />
                                            <p className="text-slate-400">
                                                {filterStatus === 'completed' 
                                                    ? 'No completed shows yet. Keep watching!' 
                                                    : 'No shows in progress. All shows are completed!'}
                                            </p>
                                        </div>
                                    );
                                }

                                return filteredShows.map(show => {
                                    const progress = getWatchProgress(show);
                                    const isExpanded = expandedShow === show.id;

                                    return (
                                        <div key={show.id} className={`bg-slate-800 rounded-lg p-4 shadow-xl ${
                                            progress.percentage === 100 
                                                ? 'ring-2 ring-green-500 ring-opacity-50 shadow-green-500/20' 
                                                : ''
                                        }`}>
                                            <div className="flex items-start gap-4">
                                                {show.image && (
                                                    <img
                                                        src={show.image}
                                                        alt={show.name}
                                                        className="w-20 h-30 object-cover rounded"
                                                    />
                                                )}
                                                <div className="flex-1">
                                                    <div className="flex items-start justify-between mb-2">
                                                        <div className="flex items-center gap-3">
                                                            <div>
                                                                <div className="flex items-center gap-2">
                                                                    <h3 className="text-xl font-semibold">{show.name}</h3>
                                                                    {progress.percentage === 100 && (
                                                                        <span className="flex items-center gap-1 px-3 py-1 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full text-xs font-bold text-white shadow-lg animate-pulse">
                                                                            <Icon name="check" className="w-4 h-4" />
                                                                            COMPLETED
                                                                        </span>
                                                                    )}
                                                                </div>
                                                                <p className="text-sm text-slate-400">
                                                                    {show.genres.join(', ')} â€¢ {show.premiered?.split('-')[0]}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <button
                                                            onClick={() => removeShow(show.id)}
                                                            className="text-red-400 hover:text-red-300 p-2"
                                                        >
                                                            <Icon name="trash-2" className="w-5 h-5" />
                                                        </button>
                                                    </div>

                                                    <div className="mb-3">
                                                        <div className="flex justify-between text-sm text-slate-400 mb-1">
                                                            <span>Progress</span>
                                                            <span>{progress.watched} / {progress.total} episodes ({progress.percentage}%)</span>
                                                        </div>
                                                        <div className="w-full bg-slate-700 rounded-full h-2">
                                                            <div
                                                                className={`h-2 rounded-full transition-all ${
                                                                    progress.percentage === 100
                                                                        ? 'bg-gradient-to-r from-green-500 to-emerald-500'
                                                                        : 'bg-gradient-to-r from-purple-500 to-pink-500'
                                                                }`}
                                                                style={{ width: `${progress.percentage}%` }}
                                                            />
                                                        </div>
                                                        {progress.percentage === 100 && (
                                                            <p className="text-xs text-green-400 mt-1 font-semibold">
                                                                ðŸŽ‰ All episodes watched!
                                                            </p>
                                                        )}
                                                    </div>

                                                    <div className="mb-3">
                                                        <label className="text-sm text-slate-400 mb-1 block">Watching on:</label>
                                                        <input
                                                            type="text"
                                                            value={show.source}
                                                            onChange={(e) => updateSource(show.id, e.target.value)}
                                                            placeholder="Netflix, DVD, etc."
                                                            className="w-full px-3 py-2 bg-slate-700 rounded focus:outline-none focus:ring-2 focus:ring-purple-500 text-white"
                                                        />
                                                    </div>

                                                    <button
                                                        onClick={() => setExpandedShow(isExpanded ? null : show.id)}
                                                        className="flex items-center gap-2 text-purple-400 hover:text-purple-300"
                                                    >
                                                        <Icon name={isExpanded ? "chevron-down" : "chevron-right"} className="w-4 h-4" />
                                                        {isExpanded ? 'Hide' : 'Show'} Seasons & Episodes
                                                    </button>
                                                </div>
                                            </div>

                                            {isExpanded && (
                                                <div className="mt-4 space-y-3">
                                                    {Object.keys(show.seasons).sort((a, b) => Number(a) - Number(b)).map(seasonNum => {
                                                        const episodes = show.seasons[seasonNum];
                                                        const seasonProgress = getSeasonProgress(episodes);
                                                        const isSeasonExpanded = expandedSeason === `${show.id}-${seasonNum}`;

                                                        return (
                                                            <div key={seasonNum} className="bg-slate-700 rounded-lg p-4">
                                                                <button
                                                                    onClick={() => setExpandedSeason(isSeasonExpanded ? null : `${show.id}-${seasonNum}`)}
                                                                    className="w-full flex items-center justify-between mb-2"
                                                                >
                                                                    <div className="flex items-center gap-2">
                                                                        <Icon name={isSeasonExpanded ? "chevron-down" : "chevron-right"} className="w-4 h-4" />
                                                                        <span className="font-semibold">Season {seasonNum}</span>
                                                                        <span className="text-sm text-slate-400">
                                                                            ({seasonProgress.watched}/{seasonProgress.total})
                                                                        </span>
                                                                        {seasonProgress.watched === seasonProgress.total && seasonProgress.total > 0 && (
                                                                            <span className="flex items-center gap-1 px-2 py-0.5 bg-green-600 rounded-full text-xs font-bold">
                                                                                <Icon name="check" className="w-3 h-3" />
                                                                                Complete
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                </button>

                                                                {isSeasonExpanded && (
                                                                    <div className="space-y-2 mt-3">
                                                                        {episodes.map(episode => (
                                                                            <div
                                                                                key={episode.id}
                                                                                className="flex items-center gap-3 p-2 bg-slate-600 rounded hover:bg-slate-500 transition-colors"
                                                                            >
                                                                                <button
                                                                                    onClick={() => toggleEpisodeWatched(show.id, seasonNum, episode.id)}
                                                                                    className={`w-6 h-6 rounded border-2 flex items-center justify-center transition-colors ${
                                                                                        episode.watched
                                                                                            ? 'bg-purple-600 border-purple-600'
                                                                                            : 'border-slate-400'
                                                                                    }`}
                                                                                >
                                                                                    {episode.watched && <Icon name="check" className="w-4 h-4" />}
                                                                                </button>
                                                                                <div className="flex-1">
                                                                                    <div className="flex items-center gap-2">
                                                                                        <span className="font-medium">
                                                                                            {episode.number}. {episode.name}
                                                                                        </span>
                                                                                    </div>
                                                                                    {episode.airdate && (
                                                                                        <span className="text-xs text-slate-400">{episode.airdate}</span>
                                                                                    )}
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                        </div>
                                    );
                                });
                            })()}
                        </div>

                        {/* Footer */}
                        <div className="mt-8 text-center text-sm text-slate-400 bg-slate-800 rounded-lg p-4">
                            <p className="mb-2">ðŸ’¡ <strong>Your data is saved automatically!</strong></p>
                            <p>Export JSON regularly for backup, or Export Excel for sharing.</p>
                            <p className="mt-2 text-xs">Show data provided by TVMaze API</p>
                        </div>
                    </div>
                </div>
            );
        }

        // Render app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TVShowTracker />);
    </script>
</body>
</html>
